# Default values for devops-challenge-app
# This is a YAML-formatted file.

namespace: production

# Application Configuration
app:
  name: devops-challenge-app
  image:
    repository: docker.io/albertorainieri/devops-challenge
    tag: production
    pullPolicy: IfNotPresent
  replicas: 2
  service:
    type: ClusterIP
    port: 80
    targetPort: 3000
  resources:
    requests:
      memory: "256Mi"
      cpu: "100m"
    limits:
      memory: "512Mi"
      cpu: "500m"
  env:
    NODE_ENV: production
    PORT: "3000"
  livenessProbe:
    httpGet:
      path: /
      port: 3000
    initialDelaySeconds: 40
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    httpGet:
      path: /
      port: 3000
    initialDelaySeconds: 30
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# MongoDB Configuration
mongodb:
  enabled: true
  image:
    repository: mongo
    tag: "7.0"
  replicas: 3
  # StatefulSet configuration
  statefulset:
    podManagementPolicy: "OrderedReady" # OrderedReady or Parallel
    updateStrategy:
      type: "RollingUpdate" # RollingUpdate or OnDelete
      rollingUpdate:
        partition: 0 # Update pods with index >= partition (for canary updates)

  service:
    type: ClusterIP
    port: 27017
  persistence:
    enabled: true
    size: 10Gi
    storageClass: "efs-sc" # Use EFS storage class for dynamic provisioning
    accessModes:
      - ReadWriteMany # EFS supports ReadWriteMany, allowing multiple pods to access the same volume
    # InitContainer to fix permissions on EFS volumes
    # NOTE: EFS volumes may need permission fixes depending on access point configuration
    initContainer:
      enabled: true # Set to true to enable permission fix initContainer
      runAsRoot: false # Set to true to run as root (required for permission fixes)
      image: busybox:1.36 # Lightweight image for permission fixes
      userId: "1000" # MongoDB user UID
      groupId: "1000" # MongoDB group GID
      permissions: "700" # Directory permissions (700 = rwx------, most secure: owner-only access)
    # PersistentVolume configuration (static provisioning) - DISABLED for StatefulSet
    # StatefulSet uses volumeClaimTemplates for dynamic PVC creation per pod
    persistentVolume:
      enabled: false # Disabled - StatefulSet uses volumeClaimTemplates instead
  resources:
    requests:
      memory: "512Mi"
      cpu: "250m"
    limits:
      memory: "1Gi"
      cpu: "500m"
  livenessProbe:
    exec:
      command:
        - mongosh
        - --eval
        - db.adminCommand("ping")
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    failureThreshold: 3
  readinessProbe:
    exec:
      command:
        - mongosh
        - --eval
        - db.adminCommand("ping")
    initialDelaySeconds: 10
    periodSeconds: 5
    timeoutSeconds: 3
    failureThreshold: 3

# MongoDB Secrets
mongodbSecret:
  username: "user-test"
  password: "password-test"
  database: "devops-challenge"
  # Use existing secret name instead of creating one
  existingSecret: ""

# ConfigMap
configMap:
  enabled: true

# Ingress Configuration
ingress:
  enabled: true  # Enable ingress to route traffic through nginx ingress controller
  className: nginx
  annotations: {}
    # nginx.ingress.kubernetes.io/rewrite-target: /
    # alb.ingress.kubernetes.io/target-type: ip
    # alb.ingress.kubernetes.io/scheme: internet-facing
  hosts:
    - host: devops-challenge.dev  # Update with your domain or use * for any host
      paths:
        - path: /
          pathType: Prefix
  tls: []
  #  - secretName: tech-challenge-tls
  #    hosts:
  #      - tech-challenge.local

# Service Account
serviceAccount:
  create: false
  name: ""

# Pod Annotations
podAnnotations: {}

# Pod Security Context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 1000
  fsGroup: 1000

# Security Context for containers
securityContext:
  app:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000
    capabilities:
      drop:
        - ALL
  mongodb:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: false
    runAsNonRoot: true
    runAsUser: 1000 # Changed to UID 1000 to match EFS access point



